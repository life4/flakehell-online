<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WPS Console</title>
  <link rel="shortcut icon" href="favicon.ico">

  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/js/bootstrap.min.js"
    integrity="sha384-o+RDsa0aLu++PJvFqy8fFScvbHFLtbvScb8AjopnFD+iEQ7wo/CG0xlczd+2O/em" crossorigin="anonymous">
  </script>
  <script src="https://pyodide-cdn2.iodide.io/v0.15.0/full/pyodide.js" crossorigin="anonymous">
  </script>
</head>

<body>
  <h1 class="text-center">WPS</h1>
  <div class="container-fluid">
    <div class="container">
      <div class="row">

        <div class="col-md-6">
          <div class="row">

            <div class="col-md-12">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">code</h5>
                  <p class="card-text" id="py-code" contenteditable="true">a=1+2</p>
                  <button href="#" class="btn btn-outline-primary" disabled onclick="lint()" id="py-lint">
                    run flake8
                  </button>
                </div>
              </div>
            </div>

            <form class="col-md-12" onsubmit="python_input_run()">
              <textarea class="form-control" id="py-input-run"></textarea>
              <button type="submit" class="btn btn-primary col-md-12">run</button>
            </form>

            <form class="col-md-12" onsubmit="python_input_install()">
              <input type="text" class="form-control" id="py-input-install" />
              <button type="submit" class="btn btn-primary col-md-12">install</button>
            </form>

            <form class="col-md-12" onsubmit="python_input_skip()">
              <input type="text" class="form-control" id="py-input-skip" />
              <button type="submit" class="btn btn-primary col-md-12">skip</button>
            </form>

            <form class="col-md-12" onsubmit="false">
              <button type="submit" class="btn btn-primary col-md-12" onclick="el_out.innerText = ''">clear</button>
            </form>

          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">console</h5>
              <div class="card-text" id="py-output"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script type="text/javascript">
    el_out = document.getElementById('py-output')
    el_code = document.getElementById('py-code')

    function add_output(text, cls) {
      if (text === undefined) {
        return
      }
      el = document.createElement('div')
      el.setAttribute('class', 'alert alert-' + cls)
      el.innerText = text
      el_out.appendChild(el)
    }

    function print_in(text) {
      add_output(text, 'secondary')
    }

    function print_out(text) {
      add_output(text, 'success')
    }

    function print_tb(text) {
      add_output(text, 'danger')
    }

    function python_run(commands) {
      try {
        commands.forEach(cmd => {
          print_in(cmd)
          print_out(pyodide.runPython(cmd))
        });
      } catch (error) {
        print_tb(error)
        return false
      }
      return true
    }

    function python_skip(pkg) {
      python_run([
        'name, version = "' + pkg + '".split("==")',
        'micropip.PACKAGE_MANAGER.installed_packages[name] = version',
      ])
    }

    async function python_install() {
      print_in('Installing micropip')
      result = await pyodide.loadPackage('micropip')
      print_out(result)

      ok = python_run(['import micropip'])
      if (!ok) {
        return
      }

      print_in('Installing flake8')
      result = await pyodide.runPython('micropip.install("flake8==3.7.9")')
      print_out(result)

      python_skip('flake8-quotes==2.1.2')
      python_skip('flake8-bugbear==19.3')
      python_skip('flake8-rst-docstrings==0.0.12')
      python_skip('flake8-eradicate==0.3.0')
      python_skip('flake8-isort==3.0.1')
      python_skip('flake8-bandit==2.1.1')

      await pyodide.runPython('micropip.install("setuptools")')
      await pyodide.runPython('micropip.install("entrypoints")')
      await pyodide.runPython('micropip.install("wemake-python-styleguide==0.14.1")')
      result = await pyodide.runPython('micropip.install("flake8-builtins")')
      print_out(result)

      python_run([
        'import sys',
        `
          class Mock:
            def get_docstring_tokens(*args):
              return []
        `,
        'sys.modules["flake8_quotes.docstring_detection"] = Mock()',
      ])
    }

    print_in('Loading python...')
    languagePluginLoader.then(function () {
      print_out('Interpreter is ready')
      python_run(['import sys', 'sys.version'])
      promise = python_install()
      promise.then(() => {
        el_lint.disabled = false
        el_out.innerText = ''
      })
    });

    el_lint = document.getElementById('py-lint')

    function lint() {
      pyodide.globals.text = el_code.innerText
      ok = python_run([
        'from pathlib import Path',
        'from textwrap import dedent',
        'path = Path("code.py")',
        'path.write_text(dedent(text))',
        'text',
      ])
      if (!ok) {
        return
      }

      python_run([
        'from flake8.main.application import Application',
        'from flake8.formatting.default import Default',
        `
          class Formatter(Default):
            def after_init(self):
              self._out = []
              return super().after_init()

            def _write(self, output):
              self._out.append(output)

          class App(Application):
            def make_formatter(self, formatter_class=None):
              self.formatter = Formatter(self.options)
        `,
        'app = App()',
        `
          code = 0
          try:
            app.run(["code.py"])
            app.exit()
          except SystemExit as err:
            code = int(err.args[0])
        `,
      ])
      if (!ok) {
        return
      }

      el_out.innerText = ''
      python_run([
        'code',
        '"\\n".join(app.formatter._out)',
      ])
    }

    el_input_run = document.getElementById('py-input-run')

    function python_input_run() {
      python_run([el_input_run.value])
      return false
    }

    el_input_install = document.getElementById('py-input-install')

    function python_input_install() {
      pkg = el_input_install.value
      print_in('Installing ' + pkg)
      promise = pyodide.runPython('micropip.install("' + pkg + '")')
      promise.then(print_out, print_tb)
      return false
    }

    el_input_skip = document.getElementById('py-input-skip')

    function python_input_skip() {
      python_skip(el_input_skip.value)
      return false
      // no wheels: eradicate
    }

  </script>
</body>

</html>
